<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Echo - Home</title>
    <link rel="stylesheet" href="https://pyscript.net/releases/2024.6.1/core.css">
    <script type="module" src="https://pyscript.net/releases/2024.6.1/core.js"></script>
    <link rel="stylesheet" href="https://pyscript.net/alpha/pyscript.css" />
    <script defer src="https://pyscript.net/alpha/pyscript.js"></script>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <header class="main-header">
        <div class="header-welcome">Welcome to Echo!</div>
        <div class="header-desc">Create meeting recordings/audio into organized meeting minutes</div>
    </header>

    <main>
        <!-- Selection Section -->
        <section class="selection-section">
            <h1>Choose an Option</h1>
            <button onclick="showSection('file-input-section')">Upload Your Files</button>
            <button onclick="showSection('record-audio-section')">Record Audio</button>
        </section>

        <!-- File Input Section -->
        <section class="file-input-section" style="display: none;">
            <h1>Upload Your Files</h1>
            <form id="user-form">
                <div class="input-group">
                    <label for="wav-input">WAV File:</label>
                    <input type="file" id="wav-input" name="wav-input" accept=".wav">
                </div>
                <div class="input-group">
                    <label for="file-input">Document File Name:</label>
                    <input type="text" id="file-input" name="file-input" placeholder="Enter filename">
                </div>
                <button type="button" onclick="handleInput()">Submit</button>
            </form>
            <p id="output"></p>
        </section>

        <!-- Record Audio Section -->
        <section class="record-audio-section" style="display: none;">
            <h1>Record Audio</h1>
            <button id="record-btn" onclick="startRecording()">Start Recording</button>
            <button id="stop-btn" onclick="stopRecording()" disabled>Stop Recording</button>
            <audio id="audio-playback" controls></audio>
            <p id="transcription-output"></p>
        </section>

        <!-- Preview Section -->
        <section class="preview-section" style="display: none;">
            <h1>Preview of Document</h1>
            <div id="preview-content"></div>
        </section>
    </main>

    <script>
        let mediaRecorder;
        let audioChunks = [];

        function startRecording() {
            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(stream => {
                    mediaRecorder = new MediaRecorder(stream);
                    mediaRecorder.ondataavailable = event => {
                        audioChunks.push(event.data);
                    };
                    mediaRecorder.onstop = () => {
                        const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                        audioChunks = [];

                        const audioUrl = URL.createObjectURL(audioBlob);
                        const audio = document.getElementById("audio-playback");
                        audio.src = audioUrl;

                        // Call the PyScript function to save the WAV file
                        pyodide.runPython(`window.save_wav_file(to_js(audioBlob))`);
                    };
                    mediaRecorder.start();

                    document.getElementById("record-btn").disabled = true;
                    document.getElementById("stop-btn").disabled = false;
                });
        }

        function stopRecording() {
            mediaRecorder.stop();

            document.getElementById("record-btn").disabled = false;
            document.getElementById("stop-btn").disabled = true;
        }

        // Function to show the selected section and hide others
        function showSection(sectionClass) {
            const sections = document.querySelectorAll('main section');
            sections.forEach(section => {
                if (section.classList.contains(sectionClass)) {
                    section.style.display = 'block';
                } else if (!section.classList.contains('selection-section')) {
                    section.style.display = 'none';
                }
            });
        }

        // Initial setup to show only the selection section
        document.addEventListener('DOMContentLoaded', () => {
            showSection('selection-section');
        });
    </script>

    <py-script>
        from js import document, window
        from backend.transcribeaudio import transcribe_audio
        from docx import Document
        from html import escape
        import os

        def handleInput():
            wav_input = document.getElementById("wav-input").files[0]
            filename = document.getElementById("file-input").value
            if not wav_input or not filename:
                document.getElementById("output").innerText = "Please provide a WAV file and a document filename."
                return
            
            result = transcribe_audio(wav_input)
            minutes = meeting_minutes(result)
            save_as_docx(minutes, filename)

            # Hide form and show preview
            document.querySelector(".file-input-section").style.display = "none"
            document.querySelector(".preview-section").style.display = "block"

            # Display preview
            preview_html = docx_to_html(f"{filename}.docx")
            document.getElementById("preview-content").innerHTML = preview_html

        def save_wav_file(blob):
            array_buffer = blob.arrayBuffer().to_py()
            audio_data = np.frombuffer(array_buffer, dtype=np.int16)
            
            with wave.open('recorded_audio.wav', 'wb') as wf:
                wf.setnchannels(1)
                wf.setsampwidth(2)
                wf.setframerate(44100)
                wf.writeframes(audio_data)
    
            result = transcribe_audio('recorded_audio.wav')
            minutes = meeting_minutes(result)
            save_as_docx(minutes, 'recorded_audio')

            # Hide form and show preview
            document.querySelector(".record-audio-section").style.display = "none"
            document.querySelector(".preview-section").style.display = "block"

            # Display preview
            preview_html = docx_to_html("recorded_audio.docx")
            document.getElementById("preview-content").innerHTML = preview_html

        def docx_to_html(docx_path):
            doc = Document(docx_path)
            html_content = "<html><body>"
            for para in doc.paragraphs:
                html_content += f"<p>{escape(para.text)}</p>"
            html_content += "</body></html>"
            return html_content
        
        window.handleInput = handleInput
        window.save_wav_file = save_wav_file
    </py-script>

    <footer class="footer">
        <div class="footer-content">
            <a href="https://github.com/eichc/echo" target="_blank">GitHub</a>
            <span class="separator">|</span>
            <a href="https://new.rcos.io" target="_blank">An RCOS Project</a>
            <span class="separator">|</span>
            <a href="/frontend/about.html">About Us</a>
        </div>
    </footer>
</body>
</html>
