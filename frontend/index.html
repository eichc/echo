<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Echo - Home</title>
  <link rel="icon" href="/frontend/assets/favicon.png" />
  <link rel="stylesheet" href="https://pyscript.net/releases/2024.6.1/core.css" />
  <script type="module" src="https://pyscript.net/releases/2024.6.1/core.js"></script>
  <link rel="stylesheet" href="https://pyscript.net/alpha/pyscript.css" />
  <script defer src="https://pyscript.net/alpha/pyscript.js"></script>
  <link rel="stylesheet" href="styles.css" />
</head>

<body>
  <header class="main-header">
    <a class="header-a" href="/frontend/index.html"><img class="header-logo" src="/frontend/assets/logo.png" /></a>
  </header>

  <div class="main-content">
    <h1 class="title">Welcome to Echo!</h1>
    <div class="welcome-desc">
      Create meeting recordings/audio into organized meeting minutes
    </div>

    <main>
      <!-- Selection Section -->
      <section class="selection-section">
        <h1>Choose an Option</h1>
        <button onclick="showSection('file-input-section')">
          Upload Your File
        </button>
        <button onclick="showSection('record-audio-section')">
          Record Audio
        </button>
      </section>

      <section class="file-input-section" style="display: none;">
        <h1>Upload Your File</h1>
        <form id="upload-form">
          <div class="input-group">
            <label for="mp3-input">Audio File:</label>
            <input type="file" id="mp3-input" name="mp3-input" accept=".mp3" />
          </div>
          <div class="input-group">
            <label for="file-input">Output File Name (Include .docx/.pdf Extension):</label>
            <input type="text" id="file-input" name="file-input" placeholder="Enter filename">
          </div>
          <div class="input-group">
            <label for="doc-format">Choose Document Format:</label>
            <div class="doc-type-select">
              <input type="radio" id="docx" name="doc-format" value="docx" checked>
              <label for="docx" class="doc-type-select-option">Word Document</label>
            </div>
            <div class="doc-type-select">
              <input type="radio" id="pdf" name="doc-format" value="pdf">
              <label for="pdf" class="doc-type-select-option">PDF</label>
            </div>
          </div>
          <button type="button" onclick="handleFileInput()">Submit</button>
        </form>
        <p id="output"></p>
      </section>

      <section class="record-audio-section" style="display: none;">
        <h1>Record Audio</h1>
        <button id="record-btn" onclick="startRecording()">
          Start Recording
        </button>
        <button id="stop-btn" onclick="stopRecording()" disabled>
          Stop Recording
        </button>
        <audio id="audio-playback" controls></audio>
        <form id="record-form">
          <div class="input-group">
            <label for="audio-file-input">Output File Name (Include .docx/.pdf Extension):</label>
            <input type="text" id="audio-file-input" name="audio-file-input" placeholder="Enter filename">
          </div>
          <div class="input-group">
            <label for="audio-doc-format">Choose Document Format:</label>
            <div class="doc-type-select">
              <input type="radio" id="docx" name="audio-doc-format" value="docx" checked>
              <label for="docx" class="doc-type-select-option">Word Document</label>
            </div>
            <div class="doc-type-select">
              <input type="radio" id="pdf" name="audio-doc-format" value="pdf">
              <label for="pdf" class="doc-type-select-option">PDF</label>
            </div>
          </div>
          <button type="button" onclick="handleAudioInput()">Submit</button>
        </form>
        <p id="transcription-output"></p>
      </section>
    </main>
    
    <script>
      let mediaRecorder;
      let audioChunks = [];

      async function startRecording() {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        mediaRecorder.ondataavailable = event => {
          audioChunks.push(event.data);
        };
        mediaRecorder.onstop = async () => {
          const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
          audioChunks = [];
          const audioUrl = URL.createObjectURL(audioBlob);
          const audio = document.getElementById("audio-playback");
          audio.src = audioUrl;
          const arrayBuffer = await audioBlob.arrayBuffer();
          const pyodide = await loadPyodide();
          await pyodide.runPythonAsync(`
            from js import save_wav_file
            save_wav_file(to_js(arrayBuffer))
          `, { arrayBuffer });
        };
        mediaRecorder.start();
        document.getElementById("record-btn").disabled = true;
        document.getElementById("stop-btn").disabled = false;
      }

      function stopRecording() {
        mediaRecorder.stop();
        document.getElementById("record-btn").disabled = false;
        document.getElementById("stop-btn").disabled = true;
      }
      
      function showSection(sectionClass) {
        const sections = document.querySelectorAll("main section");
        sections.forEach((section) => {
          if (section.classList.contains(sectionClass)) {
            section.style.display = "block";
          } else if (!section.classList.contains("selection-section")) {
            section.style.display = "none";
          }
        });
      }

      document.addEventListener("DOMContentLoaded", () => {
        showSection("selection-section");
      });

      async function handleFileInput() {
        const wavInput = document.getElementById("mp3-input").files[0];
        if (!wavInput) {
          alert("Please select an audio file.");
          return;
        }
        const filename = document.getElementById("file-input").value;
        const formatChoice = document.querySelector('input[name="doc-format"]:checked').value;
        const arrayBuffer = await wavInput.arrayBuffer();
        const pyodide = await loadPyodide();
        await pyodide.runPythonAsync(`
          from js import document
          from backend.transcribeaudio import transcribe_audio, meeting_minutes, save_as_docx, save_as_pdf
          def handleFileInput(arrayBuffer, filename, formatChoice):
            result = transcribe_audio(arrayBuffer)
            minutes = meeting_minutes(result)
            if formatChoice == "docx":
              save_as_docx(minutes, filename + ".docx")
            elif formatChoice == "pdf":
              save_as_pdf(minutes, filename + ".pdf")
            document.getElementById("output").innerText = "Document saved as " + filename + "." + formatChoice
          handleFileInput(to_js(arrayBuffer), filename, formatChoice)
        `, { arrayBuffer, filename, formatChoice });
      }

      async function handleAudioInput() {
        const filename = document.getElementById("audio-file-input").value;
        const formatChoice = document.querySelector('input[name="audio-doc-format"]:checked').value;
        const pyodide = await loadPyodide();
        await pyodide.runPythonAsync(`
          from js import document
          from backend.transcribeaudio import transcribe_audio, meeting_minutes, save_as_docx, save_as_pdf
          def handleAudioInput(filename, formatChoice):
            result = transcribe_audio("recorded_audio.wav")
            minutes = meeting_minutes(result)
            if formatChoice == "docx":
              save_as_docx(minutes, filename + ".docx")
            elif formatChoice == "pdf":
              save_as_pdf(minutes, filename + ".pdf")
            document.getElementById("transcription-output").innerText = "Document saved as " + filename + "." + formatChoice
          handleAudioInput(filename, formatChoice)
        `, { filename, formatChoice });
      }
    </script>
  </div>

  <footer class="footer">
    <div class="footer-content">
      <a href="https://github.com/eichc/echo" target="_blank">GitHub</a>
      <span class="separator">|</span>
      <a href="https://new.rcos.io" target="_blank">An RCOS Project</a>
      <span class="separator">|</span>
      <a href="/frontend/about.html">About Us</a>
    </div>
  </footer>

  <py-script>
    import js
    import pyodide
    import backend.transcribeaudio as ta

    def save_wav_file(arrayBuffer):
      with open("recorded_audio.wav", "wb") as f:
        f.write(arrayBuffer)
  </py-script>
</body>

</html>